<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ROV Audit League - Tournament Edition</title>
    
    <!-- PWA & Mobile App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ROV Audit League">
    <meta name="theme-color" content="#0d0d1a">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00ffff; /* Cyan */
            --secondary-color: #ff00ff; /* Magenta */
            --accent-color: #ffff00; /* Yellow */
            --bg-color: #0d0d1a;
            --text-color: #e0e0e0;
            --border-color: rgba(0, 255, 255, 0.3);
            --gold-color: #FFD700;
            --silver-color: #C0C0C0;
            --bronze-color: #CD7F32;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            background-image:
                linear-gradient(var(--border-color) 1px, transparent 1px),
                linear-gradient(to right, var(--border-color) 1px, var(--bg-color) 1px);
            background-size: 20px 20px;
            overscroll-behavior: none;
        }

        h1, h2, h3 { font-family: 'Orbitron', sans-serif; text-shadow: 0 0 5px var(--primary-color), 0 0 10px var(--primary-color); }
        .cyber-panel { background-color: rgba(10, 25, 47, 0.8); border: 1px solid var(--primary-color); box-shadow: 0 0 15px rgba(0, 255, 255, 0.3), inset 0 0 10px rgba(0, 255, 255, 0.2); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); clip-path: polygon(0 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%); }
        
        .champion-podium .podium-item { border-width: 2px; }
        .champion-podium .gold { border-color: var(--gold-color); box-shadow: 0 0 25px var(--gold-color); }
        .champion-podium .silver { border-color: var(--silver-color); box-shadow: 0 0 20px var(--silver-color); }
        .champion-podium .bronze { border-color: var(--bronze-color); box-shadow: 0 0 15px var(--bronze-color); }
        
        .cyber-button { font-family: 'Orbitron', sans-serif; background-color: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); padding: 10px 20px; text-transform: uppercase; transition: all 0.3s ease; position: relative; overflow: hidden; box-shadow: 0 0 5px var(--primary-color), inset 0 0 5px var(--primary-color); }
        .cyber-button:hover { background-color: rgba(0, 255, 255, 0.2); box-shadow: 0 0 15px var(--primary-color); }
        .cyber-button.secondary { border-color: var(--secondary-color); color: var(--secondary-color); box-shadow: 0 0 5px var(--secondary-color), inset 0 0 5px var(--secondary-color); }
        .cyber-button.secondary:hover { background-color: rgba(255, 0, 255, 0.2); box-shadow: 0 0 15px var(--secondary-color); }
        .cyber-button.danger { border-color: #ff4d4d; color: #ff4d4d; box-shadow: 0 0 5px #ff4d4d, inset 0 0 5px #ff4d4d; }
        .cyber-button.danger:hover { background-color: rgba(255, 77, 77, 0.2); box-shadow: 0 0 15px #ff4d4d; }
        .cyber-input, .cyber-select, .cyber-textarea { background-color: rgba(0, 0, 0, 0.5); border: 1px solid var(--primary-color); color: var(--text-color); padding: 8px 12px; outline: none; transition: all 0.3s ease; }
        .cyber-input:focus, .cyber-select:focus, .cyber-textarea:focus { box-shadow: 0 0 10px var(--primary-color); border-color: var(--accent-color); }
        
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        
        .loader { width: 50px; aspect-ratio: 1; border-radius: 50%; border: 8px solid var(--primary-color); border-right-color: var(--secondary-color); animation: l2 1s infinite linear; }
        @keyframes l2 {to{transform: rotate(1turn)}}

        .standings-table { width: 100%; border-collapse: collapse; }
        .standings-table th, .standings-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .standings-table th { background-color: rgba(0, 255, 255, 0.1); font-family: 'Orbitron', sans-serif; text-transform: uppercase; }
        .standings-table tbody tr:hover { background-color: rgba(0, 255, 255, 0.05); }

        ::-webkit-scrollbar { height: 8px; width: 5px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--primary-color); }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

        /* Touch Control CSS */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none; 
            -webkit-user-select: none; 
            -khtml-user-select: none; 
            -moz-user-select: none; 
            -ms-user-select: none; 
            user-select: none; 
        }
        input, textarea, .cyber-input, .cyber-select, .cyber-textarea {
             -webkit-user-select: auto !important;
             -khtml-user-select: auto !important;
             -moz-user-select: auto !important;
             -ms-user-select: auto !important;
             user-select: auto !important;
        }
    </style>
</head>
<body class="min-h-dvh w-full p-4 md:p-8 flex items-center justify-center">
    
    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 bg-bg-color flex flex-col items-center justify-center z-[100]">
        <div class="loader"></div>
        <h1 class="text-2xl mt-4">ROV AUDIT LEAGUE</h1>
    </div>

    <div id="app-container" class="w-full max-w-7xl mx-auto pt-[env(safe-area-inset-top)] pb-[env(safe-area-inset-bottom)] pl-[env(safe-area-inset-left)] pr-[env(safe-area-inset-right)]">
        <!-- Loading View -->
        <div id="loading-view" class="flex flex-col items-center justify-center h-64">
            <div class="loader"></div>
            <p class="mt-4 text-xl text-primary-color">กำลังโหลดข้อมูล...</p>
        </div>

        <!-- Landing View -->
        <div id="landing-view" class="hidden text-center">
             <div class="flex flex-col justify-center min-h-[80vh]">
                 <h1 class="text-4xl md:text-6xl mb-4" >ROV AUDIT LEAGUE</h1>
                 <div id="tournament-summary-landing" class="my-8"></div>
                 <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                     <button id="enter-main-view-btn" class="w-full sm:w-auto cyber-button secondary">เข้าสู่หน้าทัวร์นาเมนต์</button>
                 </div>
             </div>
        </div>

        <!-- Main Content View -->
        <div id="main-view" class="hidden">
            <div class="flex flex-col justify-center min-h-[80vh]">
                <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <h1 class="text-3xl md:text-4xl cursor-pointer" id="main-title">ROV AUDIT LEAGUE</h1>
                    <div id="guest-controls" class="hidden flex-wrap justify-center items-center gap-2">
                        <button id="toggle-view-btn-guest" class="cyber-button">ดูข้อมูลทีม</button>
                        <button id="show-player-leaderboard-btn-guest" class="cyber-button">อันดับผู้เล่น</button>
                        <button id="show-rules-btn" class="cyber-button">ข้อมูล & กฎ</button>
                        <button id="show-history-btn-guest" class="cyber-button">ประวัติ</button>
                        <button id="show-login-btn" class="cyber-button">สำหรับผู้ดูแล</button>
                    </div>
                </header>

                <div class="text-center mb-6">
                    <h2 id="tournament-name" class="text-2xl text-accent-color"></h2>
                </div>
                
                <div id="tournament-podium-main" class="hidden my-8"></div>

                <!-- Upcoming Match Section -->
                <div id="upcoming-match-container" class="hidden cyber-panel p-4 my-8">
                    <h3 class="text-center text-2xl text-secondary-color mb-4">คู่แข่งขันถัดไป</h3>
                    <div id="upcoming-match-placeholder" class="text-center py-8 text-gray-500">
                        <p>ไม่มีคู่แข่งขันถัดไป</p>
                    </div>
                    <div id="upcoming-match-display" class="hidden">
                        <!-- Upcoming match info will be injected here -->
                    </div>
                </div>
                
                <div id="main-content-container">
                    <!-- Standings View -->
                    <div id="standings-view-container" class="cyber-panel p-4">
                        <div id="standings-placeholder" class="text-center py-16 text-gray-500">
                             <p>ยังไม่มีทัวร์นาเมนต์ที่กำลังแข่งขัน</p>
                             <p class="text-sm mt-2">(ผู้ดูแลสามารถสร้างได้จากเมนู)</p>
                         </div>
                         <!-- Card view for mobile -->
                        <div id="standings-cards" class="space-y-2 md:hidden">
                            <!-- Mobile cards will be injected here -->
                        </div>
                        <!-- Table view for desktop -->
                        <div class="overflow-x-auto hidden md:block">
                            <table id="standings-table" class="standings-table w-full">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Team</th>
                                        <th>Played</th>
                                        <th>Wins</th>
                                        <th>Losses</th>
                                    </tr>
                                </thead>
                                <tbody id="standings-table-body">
                                    <!-- Standings rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Scoreboard View -->
                    <div id="scoreboard-dashboard-container" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Scoreboard panels will be injected here -->
                    </div>
                </div>

                 <!-- Daily Schedule -->
                <div id="daily-schedule-container" class="cyber-panel p-4 mt-8 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-day-btn" class="cyber-button text-sm p-2">&lt;</button>
                        <h3 id="schedule-date-header" class="text-xl text-accent-color"></h3>
                        <button id="next-day-btn" class="cyber-button text-sm p-2">&gt;</button>
                    </div>
                    <div id="daily-schedule-list" class="space-y-2">
                        <p class="text-center text-gray-500">ไม่มีการแข่งขันในวันนี้</p>
                    </div>
                </div>

                <div id="admin-controls" class="hidden mt-8">
                    <div class="cyber-panel p-4 flex flex-wrap justify-center gap-2">
                        <button id="toggle-view-btn-admin" class="cyber-button">ดูข้อมูลทีม</button>
                        <button id="show-player-leaderboard-btn-admin" class="cyber-button">อันดับผู้เล่น</button>
                        <button id="manage-tournament-btn" class="cyber-button">แผงควบคุม</button>
                        <button id="manage-players-btn" class="cyber-button">จัดการผู้เล่น</button>
                        <button id="manage-teams-btn" class="cyber-button">จัดการทีม</button>
                        <button id="show-history-btn-admin" class="cyber-button">ประวัติ</button>
                        <button id="show-rules-btn-admin" class="cyber-button">ข้อมูล & กฎ</button>
                        <button id="logout-btn" class="cyber-button danger">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="login-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="cyber-panel p-8 w-11/12 max-w-sm text-center relative">
            <button id="close-login-modal-btn" class="absolute top-2 right-4 text-2xl text-primary-color hover:text-accent-color">&times;</button>
            <h2 class="text-2xl mb-6">ผู้ดูแลระบบ</h2>
            <form id="login-form" class="space-y-4">
                <input id="email" type="email" placeholder="Email" class="w-full cyber-input" autocomplete="email" required>
                <input id="password" type="password" placeholder="Password" class="w-full cyber-input" autocomplete="current-password" required>
                <button type="submit" id="login-btn" class="w-full cyber-button">Login</button>
                <p id="login-error" class="text-red-500 h-4"></p>
            </form>
        </div>
    </div>
     <div id="manage-tournament-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="cyber-panel p-6 w-11/12 max-w-3xl relative">
             <h2 class="text-2xl mb-4">แผงควบคุมแอดมิน</h2>
             <div id="create-tournament-view">
                 <p class="mb-4">ยังไม่มีทัวร์นาเมนต์ที่กำลังดำเนินการอยู่</p>
                 <div class="flex flex-wrap gap-4">
                     <button id="show-create-tournament-form-btn" class="cyber-button secondary">สร้างทัวร์นาเมนต์ใหม่</button>
                     <button id="shuffle-teams-btn" class="cyber-button">สุ่มทีมสำหรับฤดูกาลหน้า</button>
                     <button id="clear-history-btn" class="cyber-button danger">ล้างข้อมูลประวัติ</button>
                 </div>
             </div>
             <div id="active-tournament-view" class="hidden">
                 <p id="active-tournament-name" class="text-xl text-accent-color mb-4"></p>
                 <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <button id="generate-pairs-btn" class="cyber-button">สร้างคู่แข่งขัน</button>
                     <button id="tournament-settings-btn" class="cyber-button">ตั้งค่า/กฎ</button>
                     <button id="match-log-btn" class="cyber-button">บันทึกการแข่งขัน</button>
                     <button id="finalize-tournament-btn" class="cyber-button secondary">สรุปผลทัวร์นาเมนต์</button>
                     <button id="delete-tournament-btn" class="cyber-button danger">ลบทัวร์นาเมนต์นี้</button>
                 </div>
             </div>
             <div id="create-tournament-form-view" class="hidden mt-6 pt-4 border-t border-primary-color/30">
                 <h3 class="text-xl mb-2">สร้างทัวร์นาเมนต์ใหม่</h3>
                 <form id="create-tournament-form" class="space-y-4">
                     <div>
                         <label class="block text-primary-color mb-2">เลือกทีมที่เข้าร่วม (อย่างน้อย 3 ทีม):</label>
                         <div id="team-selection-list" class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-48 overflow-y-auto p-2 bg-black/20"></div>
                     </div>
                     <div class="flex gap-4">
                         <button type="submit" class="cyber-button">สร้างและเริ่ม</button>
                         <button type="button" id="cancel-create-tournament-btn" class="cyber-button secondary">ยกเลิก</button>
                     </div>
                 </form>
             </div>
             <div class="mt-6 flex justify-end">
                 <button type="button" id="close-manage-tournament-modal-btn" class="cyber-button">ปิด</button>
             </div>
        </div>
    </div>

     <div id="tournament-settings-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
         <div class="cyber-panel p-6 w-11/12 max-w-2xl relative max-h-[90vh] flex flex-col">
             <h2 class="text-2xl mb-4">ตั้งค่าทัวร์นาเมนต์</h2>
             <form id="tournament-settings-form" class="flex-grow overflow-y-auto pr-2 space-y-4">
                 <div>
                     <h3 class="text-xl text-primary-color mb-2">เงินรางวัล</h3>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                         <div>
                             <label for="prize-1st" class="block text-gold-color">อันดับ 1</label>
                             <input type="text" id="prize-1st" class="w-full cyber-input" placeholder="เช่น 10,000 บาท">
                         </div>
                         <div>
                             <label for="prize-2nd" class="block text-silver-color">อันดับ 2</label>
                             <input type="text" id="prize-2nd" class="w-full cyber-input" placeholder="เช่น 5,000 บาท">
                         </div>
                         <div>
                             <label for="prize-3rd" class="block text-bronze-color">อันดับ 3</label>
                             <input type="text" id="prize-3rd" class="w-full cyber-input" placeholder="เช่น 2,500 บาท">
                         </div>
                     </div>
                 </div>
                 <div>
                     <label for="tournament-rules-input" class="text-xl text-primary-color mb-2 block">กฎกติกาการแข่งขัน</label>
                     <textarea id="tournament-rules-input" rows="10" class="w-full cyber-textarea" placeholder="ใส่กฎการแข่งขันที่นี่..."></textarea>
                 </div>
             </form>
             <div class="mt-6 flex justify-end gap-4">
                 <button type="button" id="save-settings-btn" class="cyber-button">บันทึก</button>
                 <button type="button" id="close-settings-modal-btn" class="cyber-button secondary">ปิด</button>
             </div>
         </div>
     </div>

     <div id="rules-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
         <div class="cyber-panel p-6 w-11/12 max-w-3xl relative max-h-[90vh] flex flex-col">
             <h2 class="text-3xl mb-4 text-center text-accent-color">ข้อมูล & กฎการแข่งขัน</h2>
             <div id="rules-content" class="flex-grow overflow-y-auto pr-2 space-y-6">
                 <div id="prize-pool-display"></div>
                 <div id="rules-display" class="whitespace-pre-wrap"></div>
             </div>
             <div class="mt-6 flex justify-center">
                 <button type="button" id="close-rules-modal-btn" class="cyber-button">ปิด</button>
             </div>
         </div>
     </div>
    
     <div id="match-log-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
         <div class="cyber-panel p-6 w-11/12 max-w-2xl relative max-h-[90vh] flex flex-col">
             <h2 class="text-2xl mb-4 text-center">บันทึกการแข่งขัน (Match Log)</h2>
             <div id="match-log-list" class="flex-grow overflow-y-auto pr-2 space-y-2"></div>
             <div class="mt-6 flex justify-end">
                 <button type="button" id="close-match-log-modal-btn" class="cyber-button secondary">ปิด</button>
             </div>
         </div>
     </div>

     <div id="record-match-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
         <div class="cyber-panel p-6 w-11/12 max-w-md relative">
             <h2 class="text-2xl mb-4">บันทึกผลการแข่งขัน</h2>
             <form id="record-match-form" class="space-y-4">
                 <p id="match-description" class="text-center text-lg"></p>
                 <div>
                     <label for="winner-team" class="block text-primary-color mb-1">ทีมที่ชนะ</label>
                     <select id="winner-team" class="w-full cyber-select" required></select>
                 </div>
                 <div>
                     <label for="mvp-player" class="block text-primary-color mb-1">ผู้เล่น MVP</label>
                     <select id="mvp-player" class="w-full cyber-select" required disabled></select>
                 </div>
                 <div class="mt-6 flex justify-end space-x-4">
                     <button type="submit" class="cyber-button">บันทึก</button>
                     <button type="button" id="record-draw-btn" class="cyber-button secondary">บันทึกเป็นเสมอ</button>
                     <button type="button" id="close-record-match-modal-btn" class="cyber-button secondary">ยกเลิก</button>
                 </div>
             </form>
         </div>
     </div>

     <div id="manage-players-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
         <div class="cyber-panel p-6 w-11/12 max-w-lg relative">
             <h2 class="text-2xl mb-4">จัดการผู้เล่น</h2>
             <div class="mb-6">
                 <h3 class="text-xl text-primary-color mb-2">รายชื่อผู้เล่นทั้งหมด</h3>
                 <div id="players-list-admin" class="space-y-2 max-h-48 overflow-y-auto pr-2"></div>
             </div>
             <div class="mb-4 pt-4 border-t border-primary-color/30">
                 <h3 class="text-xl text-primary-color mb-2">เพิ่มผู้เล่นใหม่</h3>
                 <form id="add-player-form" class="flex gap-2">
                     <input id="new-player-name" type="text" placeholder="ชื่อผู้เล่นใหม่" class="w-full cyber-input" required>
                     <button type="submit" class="cyber-button">เพิ่ม</button>
                 </form>
             </div>
             <div class="mt-6 flex justify-end">
                 <button type="button" id="close-manage-players-modal-btn" class="cyber-button secondary">ปิด</button>
             </div>
         </div>
     </div>

     <div id="manage-teams-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
         <div class="cyber-panel p-6 w-11/12 max-w-lg relative">
             <h2 class="text-2xl mb-4">จัดการทีม</h2>
             <div class="mb-6">
                 <h3 class="text-xl text-primary-color mb-2">รายชื่อทีมปัจจุบัน</h3>
                 <div id="teams-list-admin" class="space-y-2 max-h-48 overflow-y-auto pr-2"></div>
             </div>
             <div class="mb-4 pt-4 border-t border-primary-color/30">
                 <h3 class="text-xl text-primary-color mb-2">เพิ่มทีมใหม่</h3>
                 <form id="add-team-form" class="space-y-2">
                     <input id="new-team-name" type="text" placeholder="ชื่อทีมใหม่" class="w-full cyber-input" required>
                      <input id="new-team-logo" type="url" placeholder="URL โลโก้ทีม (ถ้ามี)" class="w-full cyber-input">
                     <button type="submit" class="w-full cyber-button">เพิ่มทีม</button>
                 </form>
             </div>
             <div class="mt-6 flex justify-end">
                 <button type="button" id="close-manage-teams-modal-btn" class="cyber-button secondary">ปิด</button>
             </div>
         </div>
     </div>
     <div id="team-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="cyber-panel p-6 w-11/12 max-w-lg relative">
            <h2 id="team-modal-title" class="text-2xl mb-4"></h2>
            <form id="team-edit-form">
                <div class="flex items-start mb-4 gap-4">
                    <div id="team-logo-display" class="w-24 h-24 flex-shrink-0 bg-black/20 flex items-center justify-center rounded-md">
                        <!-- Logo img will be injected here -->
                    </div>
                    <div class="flex-grow">
                        <!-- For Guests -->
                        <div id="team-name-display-container" class="mb-2">
                            <label class="block text-primary-color mb-1">ชื่อทีม</label>
                            <p id="team-name-display" class="text-xl text-white p-2 rounded-md bg-black/20"></p>
                        </div>
                        <!-- For Admins -->
                        <div id="team-name-input-container" class="mb-2 hidden">
                            <label class="block text-primary-color mb-1">ชื่อทีม</label>
                            <input id="team-name-input" type="text" class="w-full cyber-input">
                        </div>
                        <div id="team-logo-input-container" class="mb-4 hidden">
                            <label class="block text-primary-color mb-1">URL โลโก้</label>
                            <input id="team-logo-input" type="url" class="w-full cyber-input">
                        </div>
                    </div>
                </div>
                <h3 class="text-xl text-primary-color mb-2">สมาชิกในทีม</h3>
                <div id="team-members-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="submit" id="save-team-btn" class="cyber-button hidden">Save Changes</button>
                    <button type="button" id="close-team-modal-btn" class="cyber-button secondary">Close</button>
                </div>
            </form>
        </div>
    </div>
     <div id="history-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
         <div class="cyber-panel p-6 w-11/12 max-w-2xl relative max-h-[90vh] flex flex-col">
             <h2 class="text-3xl mb-4 text-center text-accent-color">ประวัติทัวร์นาเมนต์</h2>
             <div id="history-list" class="flex-grow overflow-y-auto pr-2 space-y-4"></div>
             <div class="mt-6 flex justify-center">
                 <button type="button" id="close-history-modal-btn" class="cyber-button">Close</button>
             </div>
         </div>
     </div>
      <!-- Player Leaderboard Modal -->
    <div id="player-leaderboard-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="cyber-panel p-6 w-11/12 max-w-2xl relative max-h-[90vh] flex flex-col">
            <h2 class="text-3xl mb-4 text-center text-accent-color">หอเกียรติยศ - อันดับผู้เล่น</h2>
            <div id="player-leaderboard-list" class="flex-grow overflow-y-auto pr-2">
                <!-- Leaderboard table will be injected here -->
            </div>
            <div class="mt-6 flex justify-center">
                <button type="button" id="close-player-leaderboard-modal-btn" class="cyber-button">Close</button>
            </div>
        </div>
    </div>
    <!-- Player Stats Modal -->
    <div id="player-stats-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="cyber-panel p-6 w-11/12 max-w-md relative max-h-[90vh] flex flex-col">
            <h2 id="player-stats-title" class="text-3xl mb-4 text-center text-accent-color"></h2>
            <div id="player-stats-content" class="flex-grow overflow-y-auto pr-2 space-y-4">
                <!-- Player stats will be injected here -->
            </div>
            <div class="mt-6 flex justify-center">
                <button type="button" id="close-player-stats-modal-btn" class="cyber-button">Close</button>
            </div>
        </div>
    </div>

     <div id="alert-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
         <div class="cyber-panel p-8 w-11/12 max-w-sm text-center">
             <h2 id="alert-title" class="text-2xl mb-4 text-yellow-300"></h2>
             <p id="alert-message" class="mb-6"></p>
             <button id="close-alert-modal-btn" class="cyber-button">ตกลง</button>
         </div>
     </div>
     <div id="confirm-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
         <div class="cyber-panel p-8 w-11/12 max-w-md text-center">
             <h2 id="confirm-title" class="text-2xl mb-4 text-yellow-300"></h2>
             <p id="confirm-message" class="mb-6"></p>
             <div class="flex justify-center gap-4">
                 <button id="confirm-ok-btn" class="cyber-button danger">ยืนยัน</button>
                 <button id="confirm-cancel-btn" class="cyber-button secondary">ยกเลิก</button>
             </div>
         </div>
     </div>
     <!-- Edit Match Modal -->
    <div id="edit-match-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="cyber-panel p-6 w-11/12 max-w-md relative">
            <h2 class="text-2xl mb-4">แก้ไขคู่แข่งขัน</h2>
            <form id="edit-match-form" class="space-y-4">
                <p id="edit-match-description" class="text-center text-lg"></p>
                <div>
                    <label for="edit-team1" class="block text-primary-color mb-1">ทีม 1</label>
                    <select id="edit-team1" class="w-full cyber-select" required></select>
                </div>
                <div>
                    <label for="edit-team2" class="block text-primary-color mb-1">ทีม 2</label>
                    <select id="edit-team2" class="w-full cyber-select" required></select>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="submit" class="cyber-button">บันทึกการเปลี่ยนแปลง</button>
                    <button type="button" id="close-edit-match-modal-btn" class="cyber-button secondary">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="fixed bottom-[calc(1rem+env(safe-area-inset-bottom))] right-[calc(1rem+env(safe-area-inset-right))] text-xs text-primary-color/40">
        Developed by JJ
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, onSnapshot, addDoc, query, getDocs, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcDxcIc1ZgCGK2FiaCnbvLxp_WHdALOFk",
            authDomain: "rov-a-leaguetournament.firebaseapp.com",
            projectId: "rov-a-leaguetournament",
            storageBucket: "rov-a-leaguetournament.firebasestorage.app",
            messagingSenderId: "103695993756",
            appId: "1:103695993756:web:4f96a3f623768d191f1659",
            measurementId: "G-V2K7ZM46K3"
        };
        
        let app, auth, db, analytics;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            analytics = getAnalytics(app);
            setPersistence(auth, browserLocalPersistence); 
        } catch (error) { 
            console.error("Firebase initialization failed:", error); 
            document.getElementById('loading-view').innerHTML = `<p class="text-red-500">Firebase initialization failed. Please check the console.</p>`;
        }
        
        // --- Global State ---
        let teamsData = [];
        let playersData = [];
        let activeTournament = null;
        let historyData = [];
        let currentUser = null;
        let listeners = { teams: null, tournament: null, history: null, players: null };
        let currentScheduleDate = new Date();

        // --- UI Elements ---
        const mainView = document.getElementById('main-view');
        const loginModal = document.getElementById('login-modal');

        // --- Helper Functions ---
        function toISODateString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
             if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js').then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
                });
            }
            onAuthStateChanged(auth, user => {
                if (user) {
                    currentUser = user;
                    initializeDataListeners();
                } else {
                    signInAnonymously(auth).catch(error => {
                        console.error("Anonymous sign-in failed:", error);
                        if (error.code === 'auth/admin-restricted-operation') {
                             showAlert('การตั้งค่าไม่ถูกต้อง', 'กรุณาเปิดใช้งาน Anonymous Sign-In ใน Firebase Authentication console');
                        }
                    });
                }
            });
            setupEventListeners();
        });

        // --- Data Listeners ---
        function initializeDataListeners() {
            // Splash screen is handled here
            const splashScreen = document.getElementById('splash-screen');
            
            Object.values(listeners).forEach(unsubscribe => unsubscribe && unsubscribe());

            const onDataError = (collectionName, error) => {
                console.error(`Error fetching ${collectionName}:`, error);
                showAlert('เกิดข้อผิดพลาด', `ไม่สามารถโหลดข้อมูล ${collectionName} ได้: ${error.message}`);
                splashScreen.style.display = 'none'; // Hide splash on error too
            };
            
            let dataLoads = { teams: false, players: false, history: false, tournament: false };
            const checkAllDataLoaded = () => {
                if (Object.values(dataLoads).every(Boolean)) {
                    splashScreen.style.display = 'none';
                    showView('landing');
                }
            };

            listeners.teams = onSnapshot(collection(db, "teams"), snapshot => {
                teamsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                dataLoads.teams = true;
                checkAllDataLoaded();
                updateUI();
            }, (error) => onDataError('teams', error));

            listeners.players = onSnapshot(collection(db, "players"), snapshot => {
                playersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                dataLoads.players = true;
                checkAllDataLoaded();
                updateUI();
            }, (error) => onDataError('players', error));
            
            listeners.history = onSnapshot(collection(db, "history"), snapshot => {
                historyData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                dataLoads.history = true;
                checkAllDataLoaded();
                 updateUI();
            }, (error) => onDataError('history', error));

            const tournamentRef = doc(db, "tournaments", "active");
            listeners.tournament = onSnapshot(tournamentRef, doc => {
                activeTournament = doc.exists() ? { id: doc.id, ...doc.data() } : null;
                dataLoads.tournament = true;
                checkAllDataLoaded();
                updateUI();
            }, (error) => onDataError('active tournament', error));
        }

        function updateUI() {
            if (document.getElementById('splash-screen').style.display !== 'none') return; // Don't update UI if splash is visible

            renderTournamentPodium();
            renderDailySchedule();
            renderScoreboardDashboard();
            renderStandingsTable();
            renderUpcomingMatch();


            if (currentUser && !currentUser.isAnonymous) {
                showView('main-admin');
            } else {
                 if (mainView.classList.contains('hidden')) {
                     // Stay on landing if already there, otherwise show it
                     if (document.getElementById('landing-view').classList.contains('hidden')) {
                        showView('landing');
                     }
                 } else {
                     showView('main-guest');
                 }
            }
        }
        
        function handleLogin(e) { 
            e.preventDefault(); 
            const email = document.getElementById('email').value; 
            const password = document.getElementById('password').value; 
            const loginError = document.getElementById('login-error'); 
            loginError.textContent = ''; 
            
            signInWithEmailAndPassword(auth, email, password)
                .then(() => { 
                    closeModal('login-modal'); 
                    document.getElementById('login-form').reset(); 
                })
                .catch((signInError) => { 
                    if (signInError.code === 'auth/user-not-found') { 
                        createUserWithEmailAndPassword(auth, email, password)
                            .then(() => { 
                                closeModal('login-modal'); 
                                document.getElementById('login-form').reset(); 
                            })
                            .catch((createError) => { 
                                loginError.textContent = 'การสร้างบัญชีล้มเหลว'; 
                                console.error("Admin Creation Error:", createError); 
                            }); 
                    } else if (signInError.code === 'auth/invalid-credential' || signInError.code === 'auth/wrong-password') {
                        loginError.textContent = 'อีเมลหรือรหัสผ่านไม่ถูกต้อง';
                        console.error("Login error:", signInError);
                    } else { 
                        loginError.textContent = 'การเข้าสู่ระบบล้มเหลว'; 
                        console.error("Login error:", signInError); 
                    } 
                }); 
        }
        function handleLogout() { signOut(auth).catch(error => console.error("Logout failed:", error)); }

        function getTeamById(teamId) {
            if (!teamId) return null;
            return teamsData.find(t => t.id === teamId);
        }

        async function handleCreateTournament(e) {
            e.preventDefault();
            const name = new Date().toLocaleString('th-TH', { month: 'long', year: 'numeric' });
            const selectedCheckboxes = document.querySelectorAll('#team-selection-list input:checked');
            const selectedTeamIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            if (selectedTeamIds.length < 3) {
                showAlert('ผิดพลาด', `กรุณาเลือกทีมอย่างน้อย 3 ทีม`);
                return;
            }

            const standings = selectedTeamIds.map(teamId => ({
                teamId: teamId,
                wins: 0,
                losses: 0,
                matchesPlayed: 0
            }));

            // --- Logic to create initial pairings for the creation date ---
            let teamsToPair = [...selectedTeamIds];
            // Shuffle teams for initial random pairing
            for (let i = teamsToPair.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [teamsToPair[i], teamsToPair[j]] = [teamsToPair[j], teamsToPair[i]];
            }

            const initialScheduleContent = [];
            const scheduleDate = new Date();
            const dateString = toISODateString(scheduleDate);

            // Handle bye for odd number of teams
            if(teamsToPair.length % 2 !== 0){
                const byeTeam = teamsToPair.pop();
                initialScheduleContent.push({ isBye: true, team1Id: byeTeam });
            }

            // Create initial pairs for the first day
            while (teamsToPair.length >= 2) {
                const pair = teamsToPair.splice(0, 2);
                initialScheduleContent.push({ team1Id: pair[0], team2Id: pair[1] });
            }

            const initialSchedule = [{
                date: dateString,
                matches: initialScheduleContent
            }];
            // --- End of initial pairing logic ---

            const batch = writeBatch(db);
            selectedTeamIds.forEach(id => {
                const teamRef = doc(db, "teams", id);
                batch.update(teamRef, { wins: 0 });
            });
            playersData.forEach(player => {
                batch.update(doc(db, "players", player.id), { tournamentMvp: 0 });
            });

            const newTournament = {
                name: `ทัวร์นาเมนต์ประจำเดือน ${name}`,
                status: 'ongoing',
                teams: selectedTeamIds,
                standings: standings,
                schedule: initialSchedule,
                byeHistory: [],
                rules: "",
                prizes: { first: "", second: "", third: "" }
            };

            const tournamentRef = doc(db, "tournaments", "active");
            batch.set(tournamentRef, newTournament);

            try {
                await batch.commit();
                showAlert('สำเร็จ', 'สร้างทัวร์นาเมนต์และสร้างคู่แข่งขันวันแรกแล้ว');
                closeModal('manage-tournament-modal');
            } catch (error) {
                console.error("Error creating tournament:", error);
                showAlert('ผิดพลาด', 'ไม่สามารถสร้างทัวร์นาเมนต์ได้');
            }
        }

        async function handleRecordMatch(e) {
            e.preventDefault();
            const form = e.target;
            const winnerId = document.getElementById('winner-team').value;
            const mvpPlayerId = document.getElementById('mvp-player').value;
            const { team1Id, team2Id, date, matchIndex } = form.dataset;
            const loserId = (winnerId === team1Id) ? team2Id : team1Id;

            const batch = writeBatch(db);
            const tournamentRef = doc(db, "tournaments", "active");
            
            // Update standings
            const updatedStandings = JSON.parse(JSON.stringify(activeTournament.standings));
            const winnerStanding = updatedStandings.find(s => s.teamId === winnerId);
            const loserStanding = updatedStandings.find(s => s.teamId === loserId);

            if (winnerStanding) {
                winnerStanding.wins = (winnerStanding.wins || 0) + 1;
                winnerStanding.matchesPlayed = (winnerStanding.matchesPlayed || 0) + 1;
            }
            if (loserStanding) {
                loserStanding.losses = (loserStanding.losses || 0) + 1;
                loserStanding.matchesPlayed = (loserStanding.matchesPlayed || 0) + 1;
            }

            // Update schedule with winner
            const updatedSchedule = JSON.parse(JSON.stringify(activeTournament.schedule));
            const daySchedule = updatedSchedule.find(d => d.date === date);
            if (daySchedule && daySchedule.matches[matchIndex]) {
                daySchedule.matches[matchIndex].winner = winnerId;
                daySchedule.matches[matchIndex].mvp = mvpPlayerId;
            }

            batch.update(tournamentRef, { standings: updatedStandings, schedule: updatedSchedule });

            // Update MVP count
            const mvpPlayerRef = doc(db, "players", mvpPlayerId);
            const mvpPlayerData = playersData.find(p => p.id === mvpPlayerId);
            batch.update(mvpPlayerRef, { tournamentMvp: (mvpPlayerData.tournamentMvp || 0) + 1 });
            
            try {
                await batch.commit();
                showAlert('สำเร็จ', 'บันทึกผลเรียบร้อย');
                closeModal('record-match-modal');
            } catch (error) {
                console.error("Error saving match result:", error);
                showAlert('ผิดพลาด', 'ไม่สามารถบันทึกผลได้');
            }
        }
        
        function showFinalizeConfirm() {
            showConfirm( 'ยืนยันการสรุปผล', 'คุณต้องการสรุปผลทัวร์นาเมนต์นี้ใช่ไหม? การกระทำนี้ไม่สามารถย้อนกลับได้', handleFinalizeTournament );
        }
        
        async function handleFinalizeTournament() {
             if (!activeTournament || !activeTournament.standings || activeTournament.standings.length < 3) {
                showAlert('ผิดพลาด', 'มีทีมไม่เพียงพอที่จะสรุปผล (ต้องมีอย่างน้อย 3 ทีม)');
                return;
            }

            const sortedStandings = [...activeTournament.standings].sort((a, b) => b.wins - a.wins || a.losses - b.losses);
            const finalStandings = {
                first: { teamId: sortedStandings[0].teamId, teamName: getTeamById(sortedStandings[0].teamId).name },
                second: { teamId: sortedStandings[1].teamId, teamName: getTeamById(sortedStandings[1].teamId).name },
                third: { teamId: sortedStandings[2].teamId, teamName: getTeamById(sortedStandings[2].teamId).name }
            };

            const tournamentPlayers = playersData.filter(p => {
                return teamsData.some(t => activeTournament.teams.includes(t.id) && (t.playerIds || []).includes(p.id));
            });

            let tournamentMvp = { name: 'N/A', tournamentMvp: 0 };
             if (tournamentPlayers.length > 0) {
                 tournamentMvp = tournamentPlayers.reduce((best, current) => {
                     return ((current.tournamentMvp || 0) > (best.tournamentMvp || 0)) ? current : best;
                 }, { name: 'N/A', tournamentMvp: 0 });
            }

            const batch = writeBatch(db);

            // Update totalMvp for all participating players
            tournamentPlayers.forEach(player => {
                if (player.tournamentMvp && player.tournamentMvp > 0) {
                    const playerRef = doc(db, "players", player.id);
                    const newTotalMvp = (player.totalMvp || 0) + player.tournamentMvp;
                    batch.update(playerRef, { totalMvp: newTotalMvp });
                }
            });

            const tournamentRef = doc(db, "tournaments", "active");
            batch.update(tournamentRef, { status: 'completed', finalStandings, tournamentMvp });
            
            const historyRef = doc(collection(db, "history"));
            batch.set(historyRef, { 
                name: activeTournament.name, 
                standings: finalStandings, 
                timestamp: new Date(),
                rules: activeTournament.rules || "",
                prizes: activeTournament.prizes || {},
                tournamentMvp: { name: tournamentMvp.name, mvpCount: tournamentMvp.tournamentMvp }
            });

            try {
                await batch.commit();
                await deleteDoc(tournamentRef); 
                showAlert('สำเร็จ!', 'สรุปผลทัวร์นาเมนต์และบันทึกประวัติเรียบร้อย');
                closeModal('manage-tournament-modal');
            } catch (error) {
                console.error('Error finalizing tournament:', error);
                showAlert('ผิดพลาด', 'เกิดข้อผิดพลาดในการสรุปผล');
            }
        }

        function renderTournamentPodium() {
            const podiumMain = document.getElementById('tournament-podium-main');
            const summaryLanding = document.getElementById('tournament-summary-landing');
            const mainContentContainer = document.getElementById('main-content-container');
            const scheduleContainer = document.getElementById('daily-schedule-container');
            const upcomingMatchContainer = document.getElementById('upcoming-match-container');
            
            let source = null;
            if (activeTournament && activeTournament.status === 'completed') {
                source = activeTournament;
            } else if (!activeTournament) {
                source = [...historyData].sort((a,b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0))[0];
            }

            if(source && source.standings) {
                if (!source.standings.first || !source.standings.second || !source.standings.third) {
                    podiumMain.classList.add('hidden');
                    summaryLanding.classList.add('hidden');
                    if (scheduleContainer) scheduleContainer.classList.remove('hidden'); 
                    return;
                }
                const mvp = source.tournamentMvp;
                const podiumHTML = `
                    <div class="text-center">
                        <h2 class="text-2xl text-accent-color mb-4">ผลการแข่งขัน: ${source.name}</h2>
                        <div class="champion-podium flex flex-col md:flex-row justify-center items-end gap-4">
                            <div class="podium-item silver p-4 w-full md:w-1/4 order-2 md:order-1">
                                <p class="text-2xl text-silver-color">อันดับ 2</p>
                                <h3 class="text-3xl">${source.standings.second.teamName}</h3>
                            </div>
                            <div class="podium-item gold p-6 w-full md:w-1/3 order-1 md:order-2">
                                <p class="text-3xl text-gold-color">แชมป์เปี้ยน</p>
                                <h3 class="text-5xl">${source.standings.first.teamName}</h3>
                            </div>
                            <div class="podium-item bronze p-4 w-full md:w-1/4 order-3 md:order-3">
                                <p class="text-2xl text-bronze-color">อันดับ 3</p>
                                <h3 class="text-3xl">${source.standings.third.teamName}</h3>
                            </div>
                        </div>
                        ${mvp && mvp.mvpCount > 0 ? `<div class="cyber-panel mt-6 p-4 max-w-md mx-auto border-secondary-color"><p class="text-xl text-secondary-color">MVP of the Tournament</p><h3 class="text-3xl">${mvp.name} (${mvp.mvpCount} MVPs)</h3></div>` : ''}
                    </div>`;
                 podiumMain.innerHTML = podiumHTML;
                 summaryLanding.innerHTML = podiumHTML;
                 podiumMain.classList.remove('hidden');
                 summaryLanding.classList.remove('hidden');
                 mainContentContainer.classList.add('hidden');
                 scheduleContainer.classList.add('hidden');
                 upcomingMatchContainer.classList.add('hidden');
            } else {
                 podiumMain.classList.add('hidden');
                 summaryLanding.classList.add('hidden');
                 mainContentContainer.classList.remove('hidden');
                 scheduleContainer.classList.remove('hidden');
                 upcomingMatchContainer.classList.remove('hidden');
            }
        }
        
        function renderDailySchedule() {
            const container = document.getElementById('daily-schedule-container');
            if (!activeTournament || activeTournament.status === 'completed') {
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');

            const dateHeader = document.getElementById('schedule-date-header');
            const listEl = document.getElementById('daily-schedule-list');
            
            const dateString = toISODateString(currentScheduleDate);
            const todayString = toISODateString(new Date());
            let displayDateText = currentScheduleDate.toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            if (dateString === todayString) displayDateText = `วันนี้ (${displayDateText})`;
            dateHeader.textContent = displayDateText;

            const scheduleForDay = (activeTournament.schedule || []).find(s => s.date === dateString);

            if (scheduleForDay && scheduleForDay.matches.length > 0) {
                listEl.innerHTML = scheduleForDay.matches.map((match, matchIndex) => {
                    if (match.isBye) {
                        const byeTeam = getTeamById(match.team1Id);
                        return `
                        <div class="p-3 bg-black/30 flex items-center justify-center text-lg">
                            <span class="text-gray-400">${byeTeam ? byeTeam.name : 'Unknown'} - ได้พัก</span>
                        </div>
                        `;
                    }
                    
                    const team1 = getTeamById(match.team1Id);
                    const team2 = getTeamById(match.team2Id);
                    if (!team1 || !team2) return '<!-- Invalid match data -->';

                    let content;
                    if (match.winner) {
                        const winnerTeam = getTeamById(match.winner);
                        content = `<span class="text-accent-color flex-1 text-right">${winnerTeam.name} ชนะ</span>`;
                    } else if (match.isDraw) {
                        content = `<span class="text-gray-400">เสมอ</span>`;
                    } else if (currentUser && !currentUser.isAnonymous) {
                        content = `
                        <div class="flex flex-col sm:flex-row gap-2 justify-center">
                           <button data-action="record" data-team1-id="${team1.id}" data-team2-id="${team2.id}" data-date="${scheduleForDay.date}" data-match-index="${matchIndex}" class="cyber-button py-1 px-2 text-xs">บันทึกผล</button>
                           <button data-action="edit" data-team1-id="${team1.id}" data-team2-id="${team2.id}" data-date="${scheduleForDay.date}" data-match-index="${matchIndex}" class="cyber-button secondary py-1 px-2 text-xs">แก้ไข</button>
                        </div>
                        `;
                    } else {
                        content = `<span class="mx-4 text-primary-color">VS</span>`;
                    }

                    return `
                        <div class="p-3 bg-black/30 flex items-center justify-center text-lg">
                            <span class="flex-1 text-right break-words">${team1.name}</span>
                            <div class="mx-4 text-center">${content}</div>
                            <span class="flex-1 text-left break-words">${team2.name}</span>
                        </div>
                    `;
                }).join('');

                listEl.querySelectorAll('button[data-action]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const { action, team1Id, team2Id, date, matchIndex } = e.currentTarget.dataset;
                        if (action === 'record') {
                           showRecordMatchModal(team1Id, team2Id, date, parseInt(matchIndex));
                        } else if (action === 'edit') {
                           showEditMatchModal(team1Id, team2Id, date, parseInt(matchIndex));
                        }
                    });
                });
            } else {
                listEl.innerHTML = `<p class="text-center text-gray-500">ไม่มีการแข่งขันในวันนี้</p>`;
            }
        }

        function renderScoreboardDashboard() {
            const container = document.getElementById('scoreboard-dashboard-container');
            container.innerHTML = '';
            teamsData.forEach(team => {
                const panel = document.createElement('div');
                panel.className = 'cyber-panel p-4 cursor-pointer transform hover:scale-105 transition-transform duration-300 flex flex-col items-center';
                panel.onclick = () => showTeamModal(team.id);

                const standing = activeTournament ? activeTournament.standings.find(s => s.teamId === team.id) : null;
                const wins = standing ? standing.wins : 0;
                const losses = standing ? standing.losses : 0;

                const currentMvpCount = (team.playerIds || []).reduce((sum, playerId) => {
                    const player = playersData.find(p => p.id === playerId);
                    return sum + (player?.tournamentMvp || 0);
                }, 0);

                const trophies = calculateTrophies(team.name);
                
                 const logoDisplay = team.logoUrl 
                    ? `<img src="${team.logoUrl}" alt="${team.name} Logo" class="w-24 h-24 object-contain mb-2" onerror="this.onerror=null;this.src='https://placehold.co/96x96/0d0d1a/0d0d1a?text=${team.name.charAt(0)}';">`
                    : `<div class="w-24 h-24 flex items-center justify-center mb-2">
                         <svg class="w-16 h-16 text-primary-color/50" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        </div>`;

                panel.innerHTML = `
                    ${logoDisplay}
                    <h3 class="text-2xl text-center flex items-center justify-center gap-2">
                        <span>${team.name}</span>
                    </h3>
                    <p class="text-3xl sm:text-4xl font-bold text-accent-color mt-2">${wins} <span class="text-primary-color">W</span> - ${losses} <span class="text-primary-color">L</span></p>
                    <div class="flex gap-3 text-lg mt-2">
                        <span class="flex items-center" title="อันดับ 1"><svg class="w-5 h-5 text-gold-color" fill="currentColor" viewBox="0 0 24 24"><path d="M19.5 4c-1.06 0-2.05.5-2.69 1.32L16 6h-3V4c0-1.1-.9-2-2-2s-2 .9-2 2v2H6l-.81-.68C4.55 4.5 3.56 4 2.5 4 1.38 0 0 1.12 0 2.5c0 .81.39 1.54 1 2v5c0 1.66 1.34 3 3 3h1v2c0 .55.45 1 1 1h8c.55 0 1-.45 1-1v-2h1c1.66 0 3-1.34 3-3v-5c.61-.46 1-1.19 1-2 0-1.38-1.12-2.5-2.5-2.5zM18 16H6c-.55 0-1-.45-1-1v-4h14v4c0 .55-.45 1-1 1z"></path></svg><span class="ml-1">${trophies.gold}</span></span>
                        <span class="flex items-center" title="อันดับ 2"><svg class="w-5 h-5 text-silver-color" fill="currentColor" viewBox="0 0 24 24"><path d="M19.5 4c-1.06 0-2.05.5-2.69 1.32L16 6h-3V4c0-1.1-.9-2-2-2s-2 .9-2 2v2H6l-.81-.68C4.55 4.5 3.56 4 2.5 4 1.38 0 0 1.12 0 2.5c0 .81.39 1.54 1 2v5c0 1.66 1.34 3 3 3h1v2c0 .55.45 1 1 1h8c.55 0 1-.45 1-1v-2h1c1.66 0 3-1.34 3-3v-5c.61-.46 1-1.19 1-2 0-1.38-1.12-2.5-2.5-2.5zM18 16H6c-.55 0-1-.45-1-1v-4h14v4c0 .55-.45 1-1 1z"></path></svg><span class="ml-1">${trophies.silver}</span></span>
                        <span class="flex items-center" title="อันดับ 3"><svg class="w-5 h-5 text-bronze-color" fill="currentColor" viewBox="0 0 24 24"><path d="M19.5 4c-1.06 0-2.05.5-2.69 1.32L16 6h-3V4c0-1.1-.9-2-2-2s-2 .9-2 2v2H6l-.81-.68C4.55 4.5 3.56 4 2.5 4 1.38 0 0 1.12 0 2.5c0 .81.39 1.54 1 2v5c0 1.66 1.34 3 3 3h1v2c0 .55.45 1 1 1h8c.55 0 1-.45 1-1v-2h1c1.66 0 3-1.34 3-3v-5c.61-.46 1-1.19 1-2 0-1.38-1.12-2.5-2.5-2.5zM18 16H6c-.55 0-1-.45-1-1v-4h14v4c0 .55-.45 1-1 1z"></path></svg><span class="ml-1">${trophies.bronze}</span></span>
                    </div>
                    <p class="text-base text-primary-color mt-2">Total MVPs: ${currentMvpCount}</p>
                `;
                container.appendChild(panel);
            });
        }

        function calculateTrophies(teamName) {
            const trophies = { gold: 0, silver: 0, bronze: 0 };
            historyData.forEach(record => {
                if (record.standings) {
                    if (record.standings.first?.teamName === teamName) trophies.gold++;
                    if (record.standings.second?.teamName === teamName) trophies.silver++;
                    if (record.standings.third?.teamName === teamName) trophies.bronze++;
                }
            });
            return trophies;
        }

        function renderStandingsTable() {
            const placeholder = document.getElementById('standings-placeholder');
            const table = document.getElementById('standings-table');
            const tbody = document.getElementById('standings-table-body');
            const cardsContainer = document.getElementById('standings-cards');

            if (!activeTournament) {
                placeholder.classList.remove('hidden');
                table.parentElement.classList.add('hidden');
                cardsContainer.classList.add('hidden');
                return;
            }

            placeholder.classList.add('hidden');
            table.parentElement.classList.remove('hidden');
            cardsContainer.classList.remove('hidden');

            const sortedStandings = [...activeTournament.standings].sort((a, b) => b.wins - a.wins || a.losses - b.losses);

            tbody.innerHTML = sortedStandings.map((standing, index) => {
                const team = getTeamById(standing.teamId);
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${team ? team.name : 'Unknown Team'}</td>
                        <td>${standing.matchesPlayed}</td>
                        <td>${standing.wins}</td>
                        <td>${standing.losses}</td>
                    </tr>
                `;
            }).join('');
            
            cardsContainer.innerHTML = sortedStandings.map((standing, index) => {
                const team = getTeamById(standing.teamId);
                if (!team) return '';
                return `
                    <div class="flex items-center justify-between p-3 bg-black/20 rounded-md">
                        <div class="flex items-center">
                            <span class="text-lg font-bold w-8">${index + 1}</span>
                            <span class="text-lg font-semibold">${team.name}</span>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold">${standing.wins} <span class="text-xs font-normal">W</span> - ${standing.losses} <span class="text-xs font-normal">L</span></p>
                            <p class="text-xs text-gray-400">Played: ${standing.matchesPlayed}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderUpcomingMatch() {
            const container = document.getElementById('upcoming-match-container');
            const placeholder = document.getElementById('upcoming-match-placeholder');
            const display = document.getElementById('upcoming-match-display');

            if (!activeTournament || activeTournament.status !== 'ongoing') {
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');

            const upcomingMatches = (activeTournament.schedule || [])
                .flatMap(day => day.matches.filter(match => !match.winner && !match.isDraw).map(match => ({ ...match, date: day.date })))
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            if (upcomingMatches.length === 0) {
                placeholder.classList.remove('hidden');
                display.classList.add('hidden');
                display.innerHTML = ''; // Clear display in case it had content
            } else {
                const nextMatchesToShow = upcomingMatches.slice(0, 2); // Show up to 2 matches

                display.innerHTML = nextMatchesToShow.map(match => {
                    const team1 = getTeamById(match.team1Id);
                    const team2 = getTeamById(match.team2Id);

                    if (!team1 || !team2) return ''; // Skip if data is incomplete

                    const logo1 = team1.logoUrl ? `<img src="${team1.logoUrl}" class="w-20 h-20 md:w-24 md:h-24 object-contain" onerror="this.onerror=null;this.src='https://placehold.co/96x96/0d0d1a/00ffff?text=${team1.name.charAt(0)}';">` : `<div class="w-20 h-20 md:w-24 md:h-24"></div>`;
                    const logo2 = team2.logoUrl ? `<img src="${team2.logoUrl}" class="w-20 h-20 md:w-24 md:h-24 object-contain" onerror="this.onerror=null;this.src='https://placehold.co/96x96/0d0d1a/00ffff?text=${team2.name.charAt(0)}';">` : `<div class="w-20 h-20 md:w-24 md:h-24"></div>`;
                    
                    // Add T00:00:00 to avoid timezone interpretation issues
                    const matchDate = new Date(match.date + 'T00:00:00').toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long' });

                    return `
                        <div class="flex flex-col md:flex-row justify-around items-center text-center gap-4">
                            <div class="flex flex-col items-center w-full md:w-1/3">
                                ${logo1}
                                <h4 class="text-xl md:text-2xl mt-2 break-words">${team1.name}</h4>
                            </div>
                            <div class="text-center w-full md:w-1/3 my-4 md:my-0">
                                <p class="text-3xl md:text-4xl text-primary-color">VS</p>
                                <p class="text-accent-color mt-2 text-sm md:text-base">${matchDate}</p>
                            </div>
                            <div class="flex flex-col items-center w-full md:w-1/3">
                                ${logo2}
                                <h4 class="text-xl md:text-2xl mt-2 break-words">${team2.name}</h4>
                            </div>
                        </div>
                    `;
                }).join('<div class="my-4 border-t-2 border-dashed border-primary-color/20"></div>'); // Separator

                placeholder.classList.add('hidden');
                display.classList.remove('hidden');
            }
        }
        
        function setupEventListeners() {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('show-login-btn').addEventListener('click', () => { loginModal.classList.remove('hidden'); loginModal.classList.add('flex'); });
            document.getElementById('close-login-modal-btn').addEventListener('click', () => closeModal('login-modal'));
            document.getElementById('enter-main-view-btn').addEventListener('click', () => showView('main-guest'));
            document.getElementById('main-title').addEventListener('click', () => { if(!currentUser || currentUser.isAnonymous) showView('landing'); });
            
            document.getElementById('manage-teams-btn').addEventListener('click', showManageTeamsModal);
            document.getElementById('close-manage-teams-modal-btn').addEventListener('click', () => closeModal('manage-teams-modal'));
            document.getElementById('add-team-form').addEventListener('submit', handleAddTeam);
            
            document.getElementById('manage-players-btn').addEventListener('click', showManagePlayersModal);
            document.getElementById('close-manage-players-modal-btn').addEventListener('click', () => closeModal('manage-players-modal'));
            document.getElementById('add-player-form').addEventListener('submit', handleAddPlayer);
            
            document.getElementById('manage-tournament-btn').addEventListener('click', showManageTournamentModal);
            document.getElementById('close-manage-tournament-modal-btn').addEventListener('click', () => closeModal('manage-tournament-modal'));
            document.getElementById('show-create-tournament-form-btn').addEventListener('click', () => {
                document.getElementById('create-tournament-view').classList.add('hidden');
                document.getElementById('create-tournament-form-view').classList.remove('hidden');
                populateTeamSelectionList();
            });
             document.getElementById('cancel-create-tournament-btn').addEventListener('click', () => {
                document.getElementById('create-tournament-view').classList.remove('hidden');
                document.getElementById('create-tournament-form-view').classList.add('hidden');
            });
            document.getElementById('create-tournament-form').addEventListener('submit', handleCreateTournament);
            document.getElementById('record-match-form').addEventListener('submit', handleRecordMatch);
            document.getElementById('close-record-match-modal-btn').addEventListener('click', () => closeModal('record-match-modal'));
            document.getElementById('finalize-tournament-btn').addEventListener('click', showFinalizeConfirm);
            
            document.getElementById('close-team-modal-btn').addEventListener('click', () => closeModal('team-modal'));
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => closeModal('confirm-modal'));
            
            document.getElementById('show-history-btn-admin').addEventListener('click', showHistoryModal);
            document.getElementById('show-history-btn-guest').addEventListener('click', showHistoryModal);
            document.getElementById('close-history-modal-btn').addEventListener('click', () => closeModal('history-modal'));

            document.getElementById('show-player-leaderboard-btn-admin').addEventListener('click', showPlayerLeaderboardModal);
            document.getElementById('show-player-leaderboard-btn-guest').addEventListener('click', showPlayerLeaderboardModal);
            document.getElementById('close-player-leaderboard-modal-btn').addEventListener('click', () => closeModal('player-leaderboard-modal'));
            document.getElementById('close-player-stats-modal-btn').addEventListener('click', () => closeModal('player-stats-modal'));
            
            document.getElementById('close-alert-modal-btn').addEventListener('click', () => closeModal('alert-modal'));
            
            document.getElementById('prev-day-btn').addEventListener('click', () => {
                currentScheduleDate.setDate(currentScheduleDate.getDate() - 1);
                renderDailySchedule();
            });
            document.getElementById('next-day-btn').addEventListener('click', () => {
                currentScheduleDate.setDate(currentScheduleDate.getDate() + 1);
                renderDailySchedule();
            });
            document.getElementById('delete-tournament-btn').addEventListener('click', () => {
                showConfirm('ยืนยัน', `คุณต้องการลบทัวร์นาเมนต์ "${activeTournament.name}" ใช่หรือไม่?`, async () => {
                    await deleteDoc(doc(db, "tournaments", "active"));
                    showAlert('สำเร็จ', 'ลบทัวร์นาเมนต์แล้ว');
                    closeModal('manage-tournament-modal');
                });
            });
            document.getElementById('tournament-settings-btn').addEventListener('click', showTournamentSettingsModal);
            document.getElementById('close-settings-modal-btn').addEventListener('click', () => closeModal('tournament-settings-modal'));
            document.getElementById('save-settings-btn').addEventListener('click', handleSaveTournamentSettings);
            document.getElementById('show-rules-btn-admin').addEventListener('click', showRulesModal);
            document.getElementById('show-rules-btn').addEventListener('click', showRulesModal);
            document.getElementById('close-rules-modal-btn').addEventListener('click', () => closeModal('rules-modal'));
            document.getElementById('match-log-btn').addEventListener('click', showMatchLogModal);
            document.getElementById('close-match-log-modal-btn').addEventListener('click', () => closeModal('match-log-modal'));
            document.getElementById('close-edit-match-modal-btn').addEventListener('click', () => closeModal('edit-match-modal'));
            
            document.getElementById('toggle-view-btn-guest').addEventListener('click', toggleMainView);
            document.getElementById('toggle-view-btn-admin').addEventListener('click', toggleMainView);
            document.getElementById('generate-pairs-btn').addEventListener('click', generateAndSchedulePairings);
            document.getElementById('shuffle-teams-btn').addEventListener('click', handleShuffleTeams);
            document.getElementById('clear-history-btn').addEventListener('click', handleClearHistory);
        }

        function toggleMainView() {
            const standingsContainer = document.getElementById('standings-view-container');
            const dashboardContainer = document.getElementById('scoreboard-dashboard-container');
            const guestBtn = document.getElementById('toggle-view-btn-guest');
            const adminBtn = document.getElementById('toggle-view-btn-admin');

            const isStandingsVisible = !standingsContainer.classList.contains('hidden');
            
            if (isStandingsVisible) {
                standingsContainer.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
                guestBtn.textContent = 'ดูตารางคะแนน';
                adminBtn.textContent = 'ดูตารางคะแนน';
            } else {
                standingsContainer.classList.remove('hidden');
                dashboardContainer.classList.add('hidden');
                guestBtn.textContent = 'ดูข้อมูลทีม';
                adminBtn.textContent = 'ดูข้อมูลทีม';
            }
        }

        function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); document.getElementById(modalId).classList.remove('flex');}
        function showAlert(title, message) { const modal = document.getElementById('alert-modal'); document.getElementById('alert-title').textContent = title; document.getElementById('alert-message').textContent = message; modal.classList.remove('hidden'); modal.classList.add('flex'); }
        function showConfirm(title, message, onOk) { const modal = document.getElementById('confirm-modal'); document.getElementById('confirm-title').textContent = title; document.getElementById('confirm-message').textContent = message; const okBtn = document.getElementById('confirm-ok-btn'); okBtn.onclick = () => { closeModal('confirm-modal'); onOk(); }; modal.classList.remove('hidden'); modal.classList.add('flex'); }

        function showView(viewName) {
            document.getElementById('loading-view').classList.add('hidden');
            document.getElementById('landing-view').classList.add('hidden');
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('admin-controls').classList.add('hidden');
            document.getElementById('guest-controls').classList.add('hidden');

            if (viewName === 'loading') {
                // Don't show loading view if splash is visible
                if (document.getElementById('splash-screen').style.display === 'none') {
                    document.getElementById('loading-view').classList.remove('hidden');
                }
            }
            else if (viewName === 'landing') document.getElementById('landing-view').classList.remove('hidden');
            else if (viewName === 'main-admin') { document.getElementById('main-view').classList.remove('hidden'); document.getElementById('admin-controls').classList.remove('hidden'); } 
            else if (viewName === 'main-guest') { document.getElementById('main-view').classList.remove('hidden'); document.getElementById('guest-controls').classList.remove('hidden'); }
        }

        async function handleShuffleTeams() {
            if (activeTournament) {
                showAlert('ผิดพลาด', 'ไม่สามารถสุ่มทีมได้ในขณะที่มีทัวร์นาเมนต์กำลังแข่งขัน');
                return;
            }

            const allTeamsHave5Players = teamsData.every(team => (team.playerIds || []).length >= 5);
            if (!allTeamsHave5Players) {
                showAlert('ผู้เล่นไม่ครบ', 'กรุณาตรวจสอบให้แน่ใจว่าทุกทีมมีผู้เล่นตัวจริงครบ 5 คนก่อนทำการสุ่ม');
                return;
            }
            
            showConfirm('ยืนยันการสุ่มทีม', 'คุณแน่ใจหรือไม่ที่จะสุ่มผู้เล่นตัวจริงทั้งหมดใหม่? การกระทำนี้จะคละผู้เล่น 5 คนแรกของทุกทีม และล้างรายชื่อผู้เล่นสำรองทั้งหมด', async () => {
                let mainPlayers = teamsData.flatMap(team => (team.playerIds || []).slice(0, 5));
                
                for (let i = mainPlayers.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [mainPlayers[i], mainPlayers[j]] = [mainPlayers[j], mainPlayers[i]];
                }

                const batch = writeBatch(db);
                teamsData.forEach((team, teamIndex) => {
                    const newMainPlayers = mainPlayers.slice(teamIndex * 5, (teamIndex * 5) + 5);
                    batch.update(doc(db, "teams", team.id), { playerIds: newMainPlayers });
                });

                try {
                    await batch.commit();
                    showAlert('สำเร็จ', 'สุ่มทีมสำหรับฤดูกาลใหม่เรียบร้อยแล้ว ผู้เล่นสำรองถูกล้างทั้งหมด');
                } catch (error) {
                    console.error("Error shuffling teams:", error);
                    showAlert('ผิดพลาด', 'เกิดข้อผิดพลาดในการสุ่มทีม');
                }
            });
        }

        async function generateAndSchedulePairings() {
            if (!activeTournament) return;

            const teamsInPendingMatches = (activeTournament.schedule || [])
                .flatMap(day => day.matches.filter(match => !match.winner && !match.isDraw))
                .flatMap(match => [match.team1Id, match.team2Id]);

            if (teamsInPendingMatches.length > 0) {
                showAlert('การแข่งขันยังไม่เสร็จสิ้น', 'กรุณาบันทึกผลการแข่งขันที่ค้างอยู่ทั้งหมดก่อนสร้างคู่ใหม่');
                return;
            }

            let availableTeams = activeTournament.standings.map(t => t.teamId);
            let byeTeamId = null;
            let updatedByeHistory = activeTournament.byeHistory || [];

            if (availableTeams.length % 2 !== 0) {
                let byeCandidates = availableTeams.filter(teamId => !updatedByeHistory.includes(teamId));
                if (byeCandidates.length === 0) {
                    updatedByeHistory = []; // Reset cycle
                    byeCandidates = availableTeams;
                }
                byeTeamId = byeCandidates[Math.floor(Math.random() * byeCandidates.length)];
                availableTeams = availableTeams.filter(id => id !== byeTeamId);
            }


            for (let i = availableTeams.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [availableTeams[i], availableTeams[j]] = [availableTeams[j], availableTeams[i]];
            }

            const newPairs = [];
            while(availableTeams.length >= 2) {
                const pair = availableTeams.splice(0, 2);
                newPairs.push({ team1Id: pair[0], team2Id: pair[1] });
            }

            if (newPairs.length === 0 && !byeTeamId) {
                showAlert('ไม่สามารถสร้างคู่', 'ไม่มีทีมเหลือพอที่จะจับคู่ได้ในขณะนี้');
                return;
            }

            const schedule = JSON.parse(JSON.stringify(activeTournament.schedule || []));
            let scheduleDate = new Date();
            scheduleDate.setHours(0, 0, 0, 0);
            
            let itemsToSchedule = [...newPairs];
            if(byeTeamId) {
                itemsToSchedule.push({ isBye: true, team1Id: byeTeamId });
                updatedByeHistory.push(byeTeamId);
            }


            while (itemsToSchedule.length > 0) {
                let todayString = toISODateString(scheduleDate);
                let daySchedule = schedule.find(s => s.date === todayString);
                
                if (daySchedule && daySchedule.matches.length > 0) {
                    scheduleDate.setDate(scheduleDate.getDate() + 1);
                    continue; 
                }

                if (!daySchedule) {
                    daySchedule = { date: todayString, matches: [] };
                    schedule.push(daySchedule);
                }
                
                daySchedule.matches.push(...itemsToSchedule);
                itemsToSchedule = [];
                
                if (itemsToSchedule.length === 0) break;

                scheduleDate.setDate(scheduleDate.getDate() + 1);
            }
            
            try {
                await updateDoc(doc(db, "tournaments", "active"), { schedule: schedule, byeHistory: updatedByeHistory });
                showAlert('สำเร็จ', `สร้างคู่แข่งขันใหม่และจัดตารางเรียบร้อย`);
            } catch (error) {
                console.error("Error scheduling matches:", error);
                showAlert('ผิดพลาด', 'ไม่สามารถบันทึกตารางแข่งขันได้');
            }
        }
        
        async function handleRecordDraw(team1Id, team2Id, date, matchIndex) {
            const batch = writeBatch(db);
            const tournamentRef = doc(db, "tournaments", "active");

            const updatedStandings = JSON.parse(JSON.stringify(activeTournament.standings));
            const team1Standing = updatedStandings.find(s => s.teamId === team1Id);
            const team2Standing = updatedStandings.find(s => s.teamId === team2Id);

            if (team1Standing) {
                team1Standing.matchesPlayed = (team1Standing.matchesPlayed || 0) + 1;
            }
            if (team2Standing) {
                team2Standing.matchesPlayed = (team2Standing.matchesPlayed || 0) + 1;
            }

            const updatedSchedule = JSON.parse(JSON.stringify(activeTournament.schedule));
            const daySchedule = updatedSchedule.find(d => d.date === date);
            if (daySchedule && daySchedule.matches[matchIndex]) {
                daySchedule.matches[matchIndex].isDraw = true;
                delete daySchedule.matches[matchIndex].winner; 
                delete daySchedule.matches[matchIndex].mvp;
            }

            batch.update(tournamentRef, { standings: updatedStandings, schedule: updatedSchedule });
            
            try {
                await batch.commit();
                showAlert('สำเร็จ', 'บันทึกผลเสมอเรียบร้อย');
                closeModal('record-match-modal');
            } catch (error) {
                console.error("Error saving match draw:", error);
                showAlert('ผิดพลาด', 'ไม่สามารถบันทึกผลเสมอได้');
            }
        }

        async function handleClearHistory() {
            showConfirm(
                'ยืนยันการล้างประวัติ', 
                'คุณแน่ใจหรือไม่ที่จะลบประวัติทัวร์นาเมนต์ทั้งหมด? การกระทำนี้ไม่สามารถย้อนกลับได้', 
                async () => {
                    const historyCollectionRef = collection(db, "history");
                    try {
                        const querySnapshot = await getDocs(historyCollectionRef);
                        if (querySnapshot.empty) {
                            showAlert('ไม่มีข้อมูล', 'ไม่มีประวัติที่จะลบ');
                            return;
                        }
                        
                        const batch = writeBatch(db);
                        querySnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        await batch.commit();
                        showAlert('สำเร็จ', 'ลบประวัติทัวร์นาเมนต์ทั้งหมดเรียบร้อยแล้ว');
                    } catch (error) {
                        console.error("Error clearing history:", error);
                        showAlert('ผิดพลาด', 'ไม่สามารถล้างประวัติได้');
                    }
                }
            );
        }

        function showRecordMatchModal(team1Id, team2Id, date, matchIndex) {
            const team1 = getTeamById(team1Id);
            const team2 = getTeamById(team2Id);
            
            const modal = document.getElementById('record-match-modal');
            const form = document.getElementById('record-match-form');
            const winnerSelect = document.getElementById('winner-team');
            const mvpSelect = document.getElementById('mvp-player');
            const drawBtn = document.getElementById('record-draw-btn');

            form.dataset.team1Id = team1Id;
            form.dataset.team2Id = team2Id;
            form.dataset.date = date;
            form.dataset.matchIndex = matchIndex;
            
            drawBtn.onclick = () => handleRecordDraw(team1Id, team2Id, date, parseInt(matchIndex));

            document.getElementById('match-description').textContent = `${team1.name} VS ${team2.name}`;
            winnerSelect.innerHTML = `<option value="${team1.id}">${team1.name}</option><option value="${team2.id}">${team2.name}</option>`;
            
            const populateMvps = (winnerId) => {
                const winnerTeam = getTeamById(winnerId);
                if (!winnerTeam || !winnerTeam.playerIds || winnerTeam.playerIds.length === 0) {
                     mvpSelect.innerHTML = '<option value="">-- ไม่มีผู้เล่นในทีม --</option>';
                     mvpSelect.disabled = true;
                     form.querySelector('button[type="submit"]').disabled = true;
                     showAlert('ผู้เล่นไม่ครบ', `ทีม ${winnerTeam.name} ยังไม่มีผู้เล่น กรุณาเพิ่มผู้เล่นก่อนบันทึกผล`);
                     return;
                }
                
                mvpSelect.innerHTML = (winnerTeam.playerIds)
                    .map(pid => playersData.find(p => p.id === pid))
                    .filter(Boolean)
                    .map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                mvpSelect.disabled = false;
                 form.querySelector('button[type="submit"]').disabled = false;
            };
            
            winnerSelect.onchange = (e) => populateMvps(e.target.value);
            populateMvps(winnerSelect.value);

            modal.classList.remove('hidden'); modal.classList.add('flex');
        }

        function showEditMatchModal(team1Id, team2Id, date, matchIndex) {
            const modal = document.getElementById('edit-match-modal');
            const form = document.getElementById('edit-match-form');
            const team1Select = document.getElementById('edit-team1');
            const team2Select = document.getElementById('edit-team2');
            const description = document.getElementById('edit-match-description');

            const matchDate = new Date(date + 'T00:00:00').toLocaleDateString('th-TH', { day: 'numeric', month: 'long' });
            description.textContent = `แก้ไขคู่แข่งขันวันที่ ${matchDate}`;

            const teamOptions = teamsData.map(team => `<option value="${team.id}">${team.name}</option>`).join('');
            team1Select.innerHTML = teamOptions;
            team2Select.innerHTML = teamOptions;

            team1Select.value = team1Id;
            team2Select.value = team2Id;

            form.onsubmit = (e) => {
                e.preventDefault();
                const newTeam1Id = team1Select.value;
                const newTeam2Id = team2Select.value;
                handleEditMatch(date, matchIndex, newTeam1Id, newTeam2Id);
            };

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        async function handleEditMatch(date, matchIndex, newTeam1Id, newTeam2Id) {
            if (newTeam1Id === newTeam2Id) {
                showAlert('ผิดพลาด', 'ไม่สามารถเลือกทีมเดียวกันเพื่อแข่งขันได้');
                return;
            }

            const updatedSchedule = JSON.parse(JSON.stringify(activeTournament.schedule));
            const daySchedule = updatedSchedule.find(d => d.date === date);

            if (daySchedule && daySchedule.matches[matchIndex]) {
                daySchedule.matches[matchIndex].team1Id = newTeam1Id;
                daySchedule.matches[matchIndex].team2Id = newTeam2Id;
            } else {
                showAlert('ผิดพลาด', 'ไม่พบข้อมูลการแข่งขันที่จะแก้ไข');
                return;
            }

            const tournamentRef = doc(db, "tournaments", "active");
            try {
                await updateDoc(tournamentRef, { schedule: updatedSchedule });
                showAlert('สำเร็จ', 'แก้ไขคู่แข่งขันเรียบร้อยแล้ว');
                closeModal('edit-match-modal');
            } catch (error) {
                console.error("Error editing match:", error);
                showAlert('ผิดพลาด', 'ไม่สามารถบันทึกการเปลี่ยนแปลงได้');
            }
        }
        
        function showManageTeamsModal() {
            renderAdminTeamsList();
            const modal = document.getElementById('manage-teams-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        function showManagePlayersModal() {
            renderAdminPlayersList();
            const modal = document.getElementById('manage-players-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        function renderAdminPlayersList() {
            const listEl = document.getElementById('players-list-admin');
            listEl.innerHTML = '';
            
            let sortedPlayers = [...playersData].sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));

            if (sortedPlayers.length === 0) {
                listEl.innerHTML = `<p class="text-center text-gray-500 p-4">ไม่มีผู้เล่นในระบบ</p>`;
                return;
            }

            listEl.innerHTML = sortedPlayers.map((player, index) => {
                return `
                    <div class="flex items-center justify-between p-2 bg-black/20" data-player-id="${player.id}">
                        <div class="flex-grow flex items-center mr-2">
                            <span class="player-name truncate">${index + 1}. ${player.name}</span>
                            <input type="text" value="${player.name}" class="cyber-input w-full hidden player-name-input text-sm p-1">
                        </div>
                        <div class="flex gap-2 flex-shrink-0">
                           <button data-action="edit" class="text-sm cyber-button py-1 px-2">แก้ไข</button>
                           <button data-action="delete" class="text-sm cyber-button danger py-1 px-2">ลบ</button>
                        </div>
                    </div>
                `;
            }).join('');

            listEl.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = e.currentTarget.dataset.action;
                    const playerDiv = e.currentTarget.closest('[data-player-id]');
                    
                    if (action === 'delete') {
                        handleDeletePlayer(playerDiv.dataset.playerId);
                    } else if (action === 'edit' || action === 'save') {
                        togglePlayerEdit(playerDiv);
                    }
                });
            });
        }

        function togglePlayerEdit(playerDiv) {
            const nameSpan = playerDiv.querySelector('.player-name');
            const nameInput = playerDiv.querySelector('.player-name-input');
            const editBtn = playerDiv.querySelector('button[data-action="edit"], button[data-action="save"]');

            if (editBtn.dataset.action === 'edit') {
                // Switch to edit mode
                nameSpan.classList.add('hidden');
                nameInput.classList.remove('hidden');
                nameInput.focus();
                editBtn.textContent = 'บันทึก';
                editBtn.dataset.action = 'save';
            } else {
                // Attempt to save
                const newName = nameInput.value.trim();
                const playerId = playerDiv.dataset.playerId;
                const oldNameText = nameSpan.textContent;
                const oldName = oldNameText.substring(oldNameText.indexOf('.') + 2);

                if (newName && newName !== oldName) {
                    handleEditPlayerName(playerId, newName);
                }
                
                // Always switch back to view mode after clicking save
                nameSpan.classList.remove('hidden');
                nameInput.classList.add('hidden');
                editBtn.textContent = 'แก้ไข';
                editBtn.dataset.action = 'edit';
            }
        }

        async function handleEditPlayerName(playerId, newName) {
            if (!newName) {
                showAlert('ผิดพลาด', 'ชื่อผู้เล่นห้ามว่าง');
                return;
            }
            const playerRef = doc(db, "players", playerId);
            try {
                await updateDoc(playerRef, { name: newName });
                showAlert('สำเร็จ', 'เปลี่ยนชื่อผู้เล่นเรียบร้อยแล้ว');
            } catch (error) {
                console.error("Error updating player name:", error);
                showAlert('ผิดพลาด', 'ไม่สามารถเปลี่ยนชื่อผู้เล่นได้');
            }
        }
        
        async function handleAddPlayer(e) {
            e.preventDefault();
            const nameInput = document.getElementById('new-player-name');
            const name = nameInput.value.trim();
            if (!name) return;
            const newPlayerData = { name, tournamentMvp: 0, totalMvp: 0, createdAt: new Date() };
             try {
                await addDoc(collection(db, "players"), newPlayerData);
                showAlert('สำเร็จ', `เพิ่มผู้เล่น "${name}" เรียบร้อย`);
                nameInput.value = '';
            } catch (error) { console.error("Error adding player: ", error); showAlert('ผิดพลาด', 'ไม่สามารถเพิ่มผู้เล่นได้'); }
        }
        
        function handleDeletePlayer(playerId) {
            const isPlayerInTeam = teamsData.some(team => team.playerIds?.includes(playerId));
            if (isPlayerInTeam) {
                showAlert('ไม่สามารถลบ', 'ผู้เล่นคนนี้ยังอยู่ในทีม กรุณาเพิ่มผู้เล่นก่อน');
                return;
            }
            const player = playersData.find(p => p.id === playerId);
            showConfirm('ยืนยันการลบ', `คุณแน่ใจหรือไม่ที่จะลบผู้เล่น "${player.name}"?`, async () => {
                 try {
                    await deleteDoc(doc(db, "players", playerId));
                    showAlert('สำเร็จ', `ลบผู้เล่น "${player.name}" เรียบร้อย`);
                } catch (error) { console.error("Error deleting player:", error); showAlert('ผิดพลาด', 'ไม่สามารถลบผู้เล่นได้'); }
            });
        }

        function renderAdminTeamsList() {
            const listEl = document.getElementById('teams-list-admin');
            if (!listEl) return;
            listEl.innerHTML = teamsData.map(team => `
                <div class="flex items-center justify-between p-2 bg-black/20">
                    <span class="flex-grow">${team.name}</span>
                    <div class="flex gap-2">
                        <button data-action="edit" data-id="${team.id}" class="text-sm cyber-button py-1 px-2">แก้ไข</button>
                        <button data-action="delete" data-id="${team.id}" class="text-sm cyber-button danger py-1 px-2">ลบ</button>
                    </div>
                </div>
            `).join('');

            listEl.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = e.currentTarget.dataset.action;
                    const id = e.currentTarget.dataset.id;
                    if (action === 'edit') showTeamModal(id);
                    else if (action === 'delete') handleDeleteTeam(id);
                });
            });
        }
        
        async function handleAddTeam(e) {
            e.preventDefault();
            const nameInput = document.getElementById('new-team-name');
            const logoInput = document.getElementById('new-team-logo');
            const name = nameInput.value.trim();
            const logoUrl = logoInput.value.trim();
            if (!name) { showAlert('ผิดพลาด', 'กรุณากรอกชื่อทีม'); return; }
            const newTeamData = { name, logoUrl, playerIds: [], wins: 0 };
            try {
                await addDoc(collection(db, "teams"), newTeamData);
                showAlert('สำเร็จ', `เพิ่มทีม "${name}" เรียบร้อย`);
                nameInput.value = '';
                logoInput.value = '';
            } catch (error) { console.error("Error adding team: ", error); showAlert('ผิดพลาด', 'ไม่สามารถเพิ่มทีมได้'); }
        }

        function handleDeleteTeam(teamId) {
            if (activeTournament && activeTournament.teams.includes(teamId)) {
                showAlert('ไม่สามารถลบได้', 'ทีมนี้กำลังอยู่ในการแข่งขันของทัวร์นาเมนต์ปัจจุบัน');
                return;
            }
            const team = getTeamById(teamId);
            showConfirm('ยืนยันการลบ', `คุณแน่ใจหรือไม่ที่จะลบทีม "${team.name}"?`, async () => {
                try {
                    await deleteDoc(doc(db, "teams", teamId));
                    showAlert('สำเร็จ', `ลบทีม "${team.name}" เรียบร้อยแล้ว`);
                } catch (error) { console.error("Error deleting team:", error); showAlert('ผิดพลาด', 'ไม่สามารถลบทีมได้'); }
            });
        }

        function showTeamModal(teamId) {
            const team = getTeamById(teamId);
            if (!team) return;
            const modal = document.getElementById('team-modal');
            const title = document.getElementById('team-modal-title');
            
            const nameInput = document.getElementById('team-name-input');
            const nameInputContainer = document.getElementById('team-name-input-container');
            const nameDisplay = document.getElementById('team-name-display');
            const nameDisplayContainer = document.getElementById('team-name-display-container');

            const logoInput = document.getElementById('team-logo-input');
            const logoDisplay = document.getElementById('team-logo-display');
            const logoInputContainer = document.getElementById('team-logo-input-container');
            
            const membersList = document.getElementById('team-members-list');
            const saveBtn = document.getElementById('save-team-btn');
            const form = document.getElementById('team-edit-form');
            const isAdmin = currentUser && !currentUser.isAnonymous;

            title.textContent = `รายละเอียดทีม: ${team.name}`;
            
            // Populate data for both display and input fields
            nameInput.value = team.name;
            nameDisplay.textContent = team.name;
            logoInput.value = team.logoUrl || '';

            // Render logo
            if (team.logoUrl) {
                logoDisplay.innerHTML = `<img src="${team.logoUrl}" alt="${team.name} Logo" class="w-full h-full object-contain" onerror="this.onerror=null;this.parentElement.innerHTML = '<svg class=\'w-16 h-16 text-primary-color/50\' fill=\'none\' stroke=\'currentColor\' viewBox=\'0 0 24 24\' xmlns=\'http://www.w3.org/2000/svg\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'2\' d=\'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z\'></path></svg>';">`;
            } else {
                logoDisplay.innerHTML = `<svg class="w-16 h-16 text-primary-color/50" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>`;
            }
            
            // Toggle visibility and disabled state based on admin status
            nameInputContainer.classList.toggle('hidden', !isAdmin);
            nameDisplayContainer.classList.toggle('hidden', isAdmin);
            logoInputContainer.classList.toggle('hidden', !isAdmin);
            saveBtn.classList.toggle('hidden', !isAdmin);
            
            membersList.innerHTML = '';
            const teamPlayerIds = team.playerIds || [];

            for(let i=0; i < 7; i++){
                const playerId = teamPlayerIds[i]; // This can be undefined
                const player = playerId ? playersData.find(p => p.id === playerId) : null;
                
                const playerDiv = document.createElement('div');
                playerDiv.className = 'flex items-center justify-between';
                const status = i < 5 ? '(ตัวจริง)' : '(สำรอง)';

                if(isAdmin){
                    const unassignedPlayers = playersData.filter(p => 
                        !teamsData.some(t => t.id !== team.id && (t.playerIds || []).includes(p.id))
                    );
                    
                    let options = '<option value="">-- ว่าง --</option>';
                    unassignedPlayers.forEach(p => {
                         options += `<option value="${p.id}" ${player && p.id === player.id ? 'selected' : ''}>${p.name}</option>`
                    });
                    
                    if (player && !unassignedPlayers.some(p => p.id === player.id)) {
                        options += `<option value="${player.id}" selected>${player.name}</option>`;
                    }

                    playerDiv.innerHTML = `
                        <select data-player-index="${i}" class="w-full cyber-select">
                           ${options}
                        </select>
                        <span class="ml-4 text-sm text-gray-400">${status}</span>
                    `;
                } else {
                      const playerInTeam = playerId ? playersData.find(p => p.id === playerId) : null;
                      playerDiv.innerHTML = `
                          <span>${playerInTeam ? playerInTeam.name : '- ว่าง -'}</span>
                          <div class="ml-4 text-sm whitespace-nowrap">
                              <span class="text-yellow-300">MVP: ${playerInTeam?.tournamentMvp || 0}</span>
                              <span class="text-primary-color/70 ml-2">(รวม: ${playerInTeam?.totalMvp || 0})</span>
                              <span class="ml-2 text-gray-500">${status}</span>
                          </div>
                      `;
                }
                membersList.appendChild(playerDiv);
            }

            form.onsubmit = (e) => { e.preventDefault(); handleSaveTeam(teamId); };
            modal.classList.remove('hidden'); modal.classList.add('flex');
        }

        async function handleSaveTeam(teamId) {
            const name = document.getElementById('team-name-input').value;
            const logoUrl = document.getElementById('team-logo-input').value;
            const memberSelects = document.querySelectorAll('#team-members-list select');
            const playerIds = Array.from(memberSelects).map(select => select.value);

            const uniquePlayerIds = playerIds.filter(id => id);
            if (new Set(uniquePlayerIds).size !== uniquePlayerIds.length) {
                showAlert('ผิดพลาด', 'ผู้เล่นหนึ่งคนสามารถอยู่ได้เพียงตำแหน่งเดียวในทีม');
                return;
            }

            try {
                await updateDoc(doc(db, "teams", teamId), { name, logoUrl, playerIds });
                showAlert('สำเร็จ', 'บันทึกข้อมูลทีมเรียบร้อย');
                closeModal('team-modal');
            } catch (error) { console.error("Error saving team:", error); showAlert('ผิดพลาด', 'ไม่สามารถบันทึกข้อมูลได้'); }
        }

        function showHistoryModal() {
             const modal = document.getElementById('history-modal');
            const listEl = document.getElementById('history-list');
            listEl.innerHTML = '';
            const sortedHistory = [...historyData].sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
            if(sortedHistory.length > 0) {
                listEl.innerHTML = sortedHistory.map(record => {
                    if (!record.standings || !record.standings.first || !record.standings.second || !record.standings.third) {
                        return `<div class="cyber-panel p-4"><h3 class="text-xl text-red-500 mb-2">ข้อมูลประวัติไม่สมบูรณ์</h3><p>${record.name || 'ไม่มีชื่อทัวร์นาเมนต์'}</p></div>`;
                    }
                    const mvp = record.tournamentMvp;
                    return `
                    <div class="cyber-panel p-4">
                        <h3 class="text-xl text-accent-color mb-2">${record.name}</h3>
                        <p><strong class="text-gold-color">อันดับ 1:</strong> ${record.standings.first.teamName}</p>
                        <p><strong class="text-silver-color">อันดับ 2:</strong> ${record.standings.second.teamName}</p>
                        <p><strong class="text-bronze-color">อันดับ 3:</strong> ${record.standings.third.teamName}</p>
                        ${mvp && mvp.mvpCount > 0 ? `<p class="mt-2"><strong class="text-secondary-color">MVP:</strong> ${mvp.name} (${mvp.mvpCount} MVPs)</p>` : ''}
                    </div>
                `}).join('');
            } else {
                 listEl.innerHTML = `<p class="text-center text-gray-500">ยังไม่มีประวัติทัวร์นาเมนต์</p>`;
            }
             modal.classList.remove('hidden'); modal.classList.add('flex');
        }

        function showPlayerLeaderboardModal() {
            const modal = document.getElementById('player-leaderboard-modal');
            const listEl = document.getElementById('player-leaderboard-list');

            const sortedPlayers = [...playersData]
                .filter(p => (p.totalMvp || 0) > 0)
                .sort((a, b) => (b.totalMvp || 0) - (a.totalMvp || 0));

            if (sortedPlayers.length === 0) {
                listEl.innerHTML = `<p class="text-center text-gray-500 p-8">ยังไม่มีผู้เล่นที่มีคะแนน MVP สะสม</p>`;
            } else {
                listEl.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="standings-table w-full">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Player</th>
                                    <th>Total MVPs</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedPlayers.map((player, index) => `
                                    <tr class="cursor-pointer" data-player-id="${player.id}">
                                        <td>${index + 1}</td>
                                        <td>${player.name}</td>
                                        <td>${player.totalMvp || 0}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            listEl.querySelectorAll('tr[data-player-id]').forEach(row => {
                row.addEventListener('click', () => {
                    showPlayerStatsModal(row.dataset.playerId);
                });
            });

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function showPlayerStatsModal(playerId) {
            const player = playersData.find(p => p.id === playerId);
            if (!player) return;

            const modal = document.getElementById('player-stats-modal');
            const titleEl = document.getElementById('player-stats-title');
            const contentEl = document.getElementById('player-stats-content');

            titleEl.textContent = player.name;
            
            const currentTeam = teamsData.find(team => (team.playerIds || []).includes(playerId));

            const mvpHistory = historyData
                .filter(tourney => tourney.tournamentMvp && tourney.tournamentMvp.name === player.name)
                .map(tourney => `<li>${tourney.name} (${tourney.tournamentMvp.mvpCount} MVPs)</li>`)
                .join('');

            contentEl.innerHTML = `
                <div class="space-y-3">
                    <p><strong>ทีมปัจจุบัน:</strong> <span class="text-accent-color">${currentTeam ? currentTeam.name : 'ไม่มีสังกัด'}</span></p>
                    <p><strong>MVP สะสมทั้งหมด:</strong> <span class="text-secondary-color">${player.totalMvp || 0}</span></p>
                    <div>
                        <h4 class="text-lg text-primary-color mb-2">ประวัติ MVP ประจำทัวร์นาเมนต์:</h4>
                        <ul class="list-disc list-inside pl-4">
                            ${mvpHistory || '<li>ยังไม่มีประวัติ</li>'}
                        </ul>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function populateTeamSelectionList() {
            const listEl = document.getElementById('team-selection-list');
            listEl.innerHTML = teamsData.map(team => `
                <label class="flex items-center space-x-2 p-2 bg-black/20 hover:bg-primary-color/20 cursor-pointer">
                    <input type="checkbox" value="${team.id}" class="form-checkbox bg-transparent border-primary-color text-primary-color focus:ring-0">
                    <span>${team.name}</span>
                </label>
            `).join('');
        }
        function showManageTournamentModal() {
            const createView = document.getElementById('create-tournament-view');
            const activeView = document.getElementById('active-tournament-view');
            const createForm = document.getElementById('create-tournament-form-view');
            if(activeTournament) {
                createView.classList.add('hidden');
                activeView.classList.remove('hidden');
                createForm.classList.add('hidden');
                document.getElementById('active-tournament-name').textContent = `ทัวร์นาเมนต์ที่กำลังแข่ง: ${activeTournament.name}`;
            } else {
                createView.classList.remove('hidden');
                activeView.classList.add('hidden');
                createForm.classList.add('hidden');
            }
            const modal = document.getElementById('manage-tournament-modal');
            modal.classList.remove('hidden'); modal.classList.add('flex');
        }
        
        function showTournamentSettingsModal() {
            if (!activeTournament) return;
            document.getElementById('prize-1st').value = activeTournament.prizes?.first || '';
            document.getElementById('prize-2nd').value = activeTournament.prizes?.second || '';
            document.getElementById('prize-3rd').value = activeTournament.prizes?.third || '';
            document.getElementById('tournament-rules-input').value = activeTournament.rules || '';
            const modal = document.getElementById('tournament-settings-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        async function handleSaveTournamentSettings() {
            const prizes = {
                first: document.getElementById('prize-1st').value,
                second: document.getElementById('prize-2nd').value,
                third: document.getElementById('prize-3rd').value
            };
            const rules = document.getElementById('tournament-rules-input').value;
            try {
                await updateDoc(doc(db, "tournaments", "active"), { prizes, rules });
                showAlert('สำเร็จ', 'บันทึกการตั้งค่าเรียบร้อยแล้ว');
                closeModal('tournament-settings-modal');
            } catch (error) {
                console.error('Error saving settings:', error);
                showAlert('ผิดพลาด', 'ไม่สามารถบันทึกการตั้งค่าได้');
            }
        }

        function showRulesModal() {
            const prizePoolEl = document.getElementById('prize-pool-display');
            const rulesEl = document.getElementById('rules-display');
            
            const source = activeTournament || [...historyData].sort((a,b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0))[0];

            if (!source) {
                showAlert('ไม่มีข้อมูล', 'ยังไม่มีข้อมูลทัวร์นาเมนต์');
                return;
            }

            const prizes = source.prizes || {};
            prizePoolEl.innerHTML = `
                <h3 class="text-2xl text-primary-color mb-2">เงินรางวัล</h3>
                <div class="space-y-2">
                    <p><strong class="text-gold-color">อันดับ 1:</strong> ${prizes.first || 'N/A'}</p>
                    <p><strong class="text-silver-color">อันดับ 2:</strong> ${prizes.second || 'N/A'}</p>
                    <p><strong class="text-bronze-color">อันดับ 3:</strong> ${prizes.third || 'N/A'}</p>
                </div>
            `;
            
            rulesEl.innerHTML = `
                <h3 class="text-2xl text-primary-color mb-2">กฎกติกา</h3>
                <p>${source.rules || 'ยังไม่มีการตั้งค่ากฎกติกา'}</p>
            `;
            
            const modal = document.getElementById('rules-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        function showMatchLogModal() {
            if(!activeTournament) return;
            const listEl = document.getElementById('match-log-list');
            listEl.innerHTML = '';
            const completedMatches = (activeTournament.schedule || [])
                .flatMap(day => day.matches.filter(match => match.winner || match.isDraw).map(match => ({ ...match, date: day.date })))
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if(completedMatches.length === 0) {
                 listEl.innerHTML = `<p class="text-center text-gray-500">ยังไม่มีผลการแข่งขันที่ถูกบันทึก</p>`;
            } else {
                listEl.innerHTML = completedMatches.map(m => {
                    const team1 = getTeamById(m.team1Id);
                    const team2 = getTeamById(m.team2Id);
                    
                    let resultText;
                    if (m.isDraw) {
                        resultText = `<strong>ผล:</strong> <span class="text-gray-400">เสมอ</span>`;
                    } else {
                        const winner = getTeamById(m.winner);
                        const mvp = playersData.find(p=>p.id === m.mvp);
                        resultText = `<strong>ผู้ชนะ:</strong> <span class="text-accent-color">${winner.name}</span> | <strong>MVP:</strong> <span class="text-secondary-color">${mvp?.name || 'N/A'}</span>`;
                    }

                    return `
                    <div class="p-2 bg-black/30">
                        <p class="text-sm text-gray-400">${new Date(m.date + 'T00:00:00').toLocaleDateString('th-TH')}</p>
                        <p><strong>${team1 ? team1.name : 'N/A'} vs ${team2 ? team2.name : 'N/A'}</strong></p>
                        <p class="text-sm">${resultText}</p>
                    </div>
                `}).join('');
            }

            const modal = document.getElementById('match-log-modal');
            modal.classList.remove('hidden'); modal.classList.add('flex');
        }
        
    </script>

</body>
</html>

